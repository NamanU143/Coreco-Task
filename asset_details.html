<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2 class="text-center mb-4">Asset Details</h2>
        <table class="table table-bordered">
            <tbody>
                <tr><th>Asset ID</th><td id="asset_id"></td></tr>
                <tr><th>Asset Name</th><td id="asset_name"></td></tr>
                <tr><th>Asset Type</th><td id="type_name"></td></tr>
                <tr><th>Brand</th><td id="brand"></td></tr>
                <tr><th>Location</th><td id="location"></td></tr>
                <tr><th>Purchase Year</th><td id="purchase_year"></td></tr>
                <tr><th>Current Owner</th><td id="current_owner"></td></tr>
            </tbody>
        </table>
        
        <button class="btn btn-warning mt-3" onclick="showModifyForm()">Modify Asset</button>
        <button class="btn btn-primary mt-3" onclick="showTransferForm()">Transfer Owner</button>
        <a href="admin_dashboard.html" class="btn btn-secondary mt-3">Back to Dashboard</a>

        <!-- Transfer Owner Form (Initially Hidden) -->
        <div id="transferOwnerForm" class="mt-4 p-3 border bg-white" style="display: none;">
            <h3>Transfer Owner</h3>
            <label class="form-label">Select New Owner</label>
            <select id="userDropdown" class="form-select mb-3"></select>
            <button class="btn btn-success" onclick="transferOwner()">Apply Transfer</button>
            <button class="btn btn-secondary" onclick="hideTransferForm()">Cancel</button>
        </div>
    </div>

    <script>
        let currentOwnerId = null; // Store current owner ID globally
        
        async function fetchAssetDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const assetId = urlParams.get("id");
            if (!assetId) {
                console.error("No asset ID provided in URL.");
                return;
            }

            try {
                let response = await fetch(`http://localhost:3000/admin/get_asset_details/${assetId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                let data = await response.json();
                if (data.assetExists && data.assetDetails) {
                    document.getElementById("asset_id").textContent = data.assetDetails.asset_id;
                    document.getElementById("asset_name").textContent = data.assetDetails.asset_name;
                    document.getElementById("type_name").textContent = data.assetDetails.type_name;
                    document.getElementById("brand").textContent = data.assetDetails.brand;
                    document.getElementById("location").textContent = data.assetDetails.location;
                    document.getElementById("purchase_year").textContent = data.assetDetails.purchase_year;
                    document.getElementById("current_owner").textContent = data.assetDetails.current_owner;
                    
                    currentOwnerId = data.assetDetails.current_owner_id; // Store the current owner ID
                } else {
                    console.error("Asset details not found:", data.message);
                }
            } catch (error) {
                console.error("Error fetching asset details:", error);
            }
        }

        async function showTransferForm() {
            document.getElementById("transferOwnerForm").style.display = "block";
            try {
                let response = await fetch("http://localhost:3000/get_users");
                let data = await response.json();
                if (data.users) {
                    let dropdown = document.getElementById("userDropdown");
                    dropdown.innerHTML = "";
                    data.users.forEach(user => {
                        let option = document.createElement("option");
                        option.value = user.id;
                        option.textContent = user.name;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error fetching user list:", error);
            }
        }

        function hideTransferForm() {
            document.getElementById("transferOwnerForm").style.display = "none";
        }

        async function transferOwner() {
            const assetId = parseInt(document.getElementById("asset_id").textContent);
            const newOwnerId = parseInt(document.getElementById("userDropdown").value);
            
            if (!currentOwnerId) {
                alert("Error: Current owner ID is missing.");
                return;
            }

            const transferData = {
                asset_id: assetId,
                from_user_id: currentOwnerId, // Use fetched current owner ID
                to_user_id: newOwnerId
            };

            try {
                const response = await fetch("http://localhost:3000/transfer_owner", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(transferData)
                });
                const result = await response.json();
                if (result.transactionStatus) {
                    alert("Transaction Successful!");
                    fetchAssetDetails();
                    hideTransferForm();
                } else {
                    alert(result.message || "Error transferring asset.");
                }
            } catch (error) {
                console.error("Error transferring asset:", error);
                alert("Failed to transfer asset. Please try again.");
            }
        }

        function showModifyForm() {
            const assetName = document.getElementById("asset_name").textContent;
            const assetType = document.getElementById("type_name").textContent;
            const brand = document.getElementById("brand").textContent;
            const location = document.getElementById("location").textContent;
            const purchaseYear = document.getElementById("purchase_year").textContent;
            const assetId = document.getElementById("asset_id").textContent;

            const modifyFormHtml = `
                <div id="modifyAssetForm" class="mt-4 p-3 border bg-white">
                    <h3>Modify Asset</h3>
                    <label class="form-label">Asset Name</label>
                    <input id="mod_asset_name" class="form-control mb-2" value="${assetName}">
                    
                    <label class="form-label">Asset Type</label>
                    <input id="mod_asset_type" class="form-control mb-2" value="${assetType}">
                    
                    <label class="form-label">Brand</label>
                    <input id="mod_brand" class="form-control mb-2" value="${brand}">
                    
                    <label class="form-label">Location</label>
                    <input id="mod_location" class="form-control mb-2" value="${location}">
                    
                    <label class="form-label">Purchase Year</label>
                    <input id="mod_purchase_year" class="form-control mb-2" type="number" value="${purchaseYear}">
                    
                    <button class="btn btn-success" onclick="modifyAsset(${assetId})">Save Changes</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('modifyAssetForm').remove()">Cancel</button>
                </div>
            `;

            document.querySelector(".container").insertAdjacentHTML("beforeend", modifyFormHtml);
        }


        
        async function fetchAssetTypes() {
            try {
                const response = await fetch("http://0.0.0.0:3000/admin/get_asset_types");
                if (!response.ok) throw new Error("Failed to fetch asset types");

                const data = await response.json();
                return data.asset_types || [];
            } catch (error) {
                console.error("Error fetching asset types:", error);
                return [];
            }
        }

        async function modifyAsset(assetId) {
            const updatedAsset = {
                asset_id: assetId,
                asset_type_name: document.getElementById("mod_asset_type").value,
                asset_name: document.getElementById("mod_asset_name").value,
                location: document.getElementById("mod_location").value,
                brand: document.getElementById("mod_brand").value,
                purchase_year: parseInt(document.getElementById("mod_purchase_year").value)
            };

            try {
                const response = await fetch("http://localhost:3000/admin/modify_assets", {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedAsset)
                });

                const result = await response.json();
                if (result.assetModification) {
                    alert("Asset modified successfully!");
                    fetchAssetDetails();
                    document.getElementById("modifyAssetForm").remove();
                } else {
                    alert(result.message || "Error modifying asset.");
                }
            } catch (error) {
                console.error("Error modifying asset:", error);
                alert("Failed to modify asset. Please try again.");
            }
        }

        document.addEventListener("DOMContentLoaded", fetchAssetDetails);
    </script>
</body>
</html>
